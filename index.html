<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <title>Tree Canopy Change Analysis (2011-2021)</title>
    
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #header {
            position: fixed; top: 0; left: 0; right: 0; height: 70px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000; display: flex; flex-direction: column; justify-content: center;
            align-items: center; /* Centers title */
        }
        #header h1 { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        #header .subtitle { font-size: 13px; opacity: 0.9; }
        
        #map { position: fixed; top: 70px; left: 0; right: 0; bottom: 0; }
        
        #chart-panel {
            position: fixed; bottom: 20px; right: 20px; width: 420px;
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;
        }
        #chart-panel h3 { font-size: 16px; color: #1f2937; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #10b981; }
        
        #legend-panel {
            position: fixed; top: 90px; right: 20px; width: 280px;
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;
        }
        #legend-panel h3 { font-size: 14px; color: #1f2937; margin-bottom: 12px; font-weight: 600; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; }
        .legend-color { width: 30px; height: 16px; border-radius: 3px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2); flex-shrink: 0; }
        
        #layer-selector-panel {
            position: fixed; top: 90px; left: 20px; width: 180px;
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;
        }
        #layer-selector-panel h3 { font-size: 14px; color: #1f2937; margin-bottom: 12px; font-weight: 600; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
        #layer-selector-panel label { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 13px; color: #374151; }
        #layer-selector-panel input[type="radio"] { margin-right: 8px; accent-color: #10b981; }

        .leaflet-top.leaflet-left { left: 20px; top: 290px; }

        /* ADDED: Styling for the new SA2 chart panel */
        #sa2-chart-panel {
            position: fixed; bottom: 20px; left: 20px; width: 420px; height: 280px;
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1001;
            display: none; /* Hidden by default */
            flex-direction: column;
        }
        #sa2-chart-panel.visible { display: flex; } /* Show it when it has the 'visible' class */
        #sa2-chart-panel h3 { font-size: 16px; color: #1f2937; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #10b981; }
        #sa2-chart-panel .chart-container { flex-grow: 1; position: relative; }
        #close-sa2-chart {
            position: absolute; top: 10px; right: 15px; background: none; border: none;
            font-size: 24px; font-weight: bold; color: #9ca3af; cursor: pointer;
        }
        #close-sa2-chart:hover { color: #374151; }
        
        @media (max-width: 768px) {
            #chart-panel, #legend-panel, #layer-selector-panel { width: calc(100% - 40px); left: 20px; right: 20px; }
            #header h1 { font-size: 18px; }
            #chart-panel { bottom: 20px; }
            #legend-panel { top: 90px; }
            #layer-selector-panel { top: auto; bottom: calc(20px + 280px + 20px + 280px + 20px); }
            #sa2-chart-panel { width: calc(100% - 40px); left: 20px; bottom: calc(20px + 280px + 20px); }
        }
    </style>
</head>
<body>
    
    <div id="header">
        <h1>🌳 Tree Canopy Change Analysis (2011-2021)</h1>
        <div class="subtitle">Melbourne Region - Click on any area to see detailed statistics</div>
    </div>
    
    <div id="map"></div>

    <div id="layer-selector-panel">
        <h3>View Data By:</h3>
        <label><input type="radio" name="layerView" value="net_change" checked> Net Change (2011-2021)</label>
        <label><input type="radio" name="layerView" value="canopy_2011"> Canopy 2011</label>
        <label><input type="radio" name="layerView" value="canopy_2015"> Canopy 2015</label>
        <label><input type="radio" name="layerView" value="canopy_2019"> Canopy 2019</label>
        <label><input type="radio" name="layerView" value="canopy_2021"> Canopy 2021</label>
    </div>
    
    <div id="legend-panel">
        <h3>📊 Current Map Legend</h3>
        <div id="dynamic-legend-content"></div>
    </div>
    
    <div id="chart-panel">
        <h3>📊 Overall Canopy Trend</h3>
        <canvas id="trend-chart" width="380" height="200"></canvas>
        <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
            Total canopy coverage across all regions
        </div>
    </div>
    
    <div id="sa2-chart-panel">
        <button id="close-sa2-chart">×</button>
        <h3 id="sa2-chart-title">Region Trend</h3>
        <div class="chart-container">
            <canvas id="sa2-chart-canvas"></canvas>
        </div>
    </div>

    <script src="js/leaflet.js"></script>
    <script src="data/canopy_area_cfin_2.js"></script>
    
    <script>
        // Initialize map
        var map = L.map('map', { zoomControl: true, maxZoom: 28, minZoom: 10 })
            .fitBounds([[-37.8657, 144.8736], [-37.7572, 145.0403]]);
        
        L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.3, attribution: 'Map data ©2015 Google', maxZoom: 20
        }).addTo(map);
        
        let activeLayerView = 'net_change';
        let sa2ChartInstance = null;

        function getColorByChange(d) { return d > 50000 ? '#059669' : d > 20000 ? '#10b981' : d > 0 ? '#6ee7b7' : d === 0 ? '#94a3b8' : d > -20000 ? '#fbbf24' : d > -50000 ? '#f97316' : '#ef4444'; }
        function getColorByCanopy(d) { return d > 200000 ? '#047857' : d > 100000 ? '#059669' : d > 50000 ? '#10b981' : d > 20000 ? '#34d399' : d > 5000 ? '#6ee7b7' : d > 0 ? '#a7f3d0' : '#e0e7e4'; }
        
        function styleFeature(feature) {
            let fillColor;
            if (activeLayerView === 'net_change') { fillColor = getColorByChange(feature.properties.net_change_m2); }
            else { const year = activeLayerView.split('_')[1]; fillColor = getColorByCanopy(feature.properties[`canopy_${year}_m2`]); }
            return { fillColor, weight: 1, opacity: 1, color: '#ffffff', fillOpacity: 0.75 };
        }
        
        // MODIFIED: createPopup reverted to show the detailed table
        function createPopup(properties) {
            const netChange = properties.net_change_m2 || 0;
            const changeSymbol = netChange > 0 ? '▲' : netChange < 0 ? '▼' : '●';
            const changeColor = netChange > 0 ? '#059669' : netChange < 0 ? '#dc2626' : '#94a3b8';
            
            return `
                <div style="min-width: 300px; font-family: Arial; padding: 5px;">
                    <h3 style="margin: 0 0 10px 0; color: #047857; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-size: 18px;">
                        ${properties.sa2_name || 'Unknown Region'}
                    </h3>
                    <p style="margin: 8px 0; color: #666; font-size: 13px;"><strong>SA1 Code:</strong> ${properties.sa1_code || 'N/A'}</p>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px;">
                        <thead><tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;"><th style="padding: 8px; text-align: left;">Year</th><th style="padding: 8px; text-align: right;">Canopy (m²)</th><th style="padding: 8px; text-align: right;">Change</th></tr></thead>
                        <tbody>
                            <tr><td style="padding: 8px;"><strong>2011</strong></td><td style="padding: 8px; text-align: right;">${(properties.canopy_2011_m2 || 0).toLocaleString()}</td><td style="padding: 8px; text-align: right; color: #94a3b8;">baseline</td></tr>
                            <tr style="background: #fafafa;"><td style="padding: 8px;"><strong>2015</strong></td><td style="padding: 8px; text-align: right;">${(properties.canopy_2015_m2 || 0).toLocaleString()}</td><td style="padding: 8px; text-align: right; font-weight: 600; color: ${(properties.change_2011_2015_m2 || 0) >= 0 ? '#059669' : '#dc2626'};">${(properties.change_2011_2015_m2 || 0) >= 0 ? '+' : ''}${(properties.change_2011_2015_m2 || 0).toLocaleString()}</td></tr>
                            <tr><td style="padding: 8px;"><strong>2019</strong></td><td style="padding: 8px; text-align: right;">${(properties.canopy_2019_m2 || 0).toLocaleString()}</td><td style="padding: 8px; text-align: right; font-weight: 600; color: ${(properties.change_2015_2019_m2 || 0) >= 0 ? '#059669' : '#dc2626'};">${(properties.change_2015_2019_m2 || 0) >= 0 ? '+' : ''}${(properties.change_2015_2019_m2 || 0).toLocaleString()}</td></tr>
                            <tr style="background: #fafafa;"><td style="padding: 8px;"><strong>2021</strong></td><td style="padding: 8px; text-align: right;">${(properties.canopy_2021_m2 || 0).toLocaleString()}</td><td style="padding: 8px; text-align: right; font-weight: 600; color: ${(properties.change_2019_2021_m2 || 0) >= 0 ? '#059669' : '#dc2626'};">${(properties.change_2019_2021_m2 || 0) >= 0 ? '+' : ''}${(properties.change_2019_2021_m2 || 0).toLocaleString()}</td></tr>
                        </tbody>
                    </table>
                </div>`;
        }

        // MODIFIED: generateSa2Chart now targets the new panel and makes it visible
        function generateSa2Chart(sa2Name) {
            if (sa2ChartInstance) { sa2ChartInstance.destroy(); }

            const sa2Features = json_canopy_area_cfin_2.features.filter(f => f.properties.sa2_name === sa2Name);
            const years = ['2011', '2015', '2019', '2021'];
            const sa2Totals = years.map(year => sa2Features.reduce((sum, f) => sum + (f.properties[`canopy_${year}_m2`] || 0), 0));

            const panel = document.getElementById('sa2-chart-panel');
            const ctx = document.getElementById('sa2-chart-canvas').getContext('2d');
            document.getElementById('sa2-chart-title').innerText = `📊 Trend for ${sa2Name}`;
            
            sa2ChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: `Canopy Coverage (m²) in ${sa2Name}`,
                        data: sa2Totals,
                        backgroundColor: ['rgba(110, 231, 183, 0.6)', 'rgba(52, 211, 153, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(5, 150, 105, 0.6)'],
                        borderColor: ['#6ee7b7', '#34d399', '#10b981', '#059669'],
                        borderWidth: 1.5
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: false, ticks: { callback: v => (v >= 1e6 ? `${(v / 1e6).toFixed(1)}M` : v >= 1e3 ? `${v / 1e3}k` : v) } } }
                }
            });
            panel.classList.add('visible'); // Show the panel
        }
        
        function highlightFeature(e) { e.target.setStyle({ weight: 3, color: '#fbbf24', fillOpacity: 0.9 }).bringToFront(); }
        function resetHighlight(e) { geojsonLayer.resetStyle(e.target); }
        
        var geojsonLayer = L.geoJSON(json_canopy_area_cfin_2, {
            style: styleFeature,
            // MODIFIED: onEachFeature now opens the table popup AND generates the external chart
            onEachFeature: function(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: function(e) {
                        // Action 1: Open the popup with the detailed table
                        L.popup({ maxWidth: 400, maxHeight: 500 })
                            .setLatLng(e.latlng)
                            .setContent(createPopup(feature.properties))
                            .openOn(map);
                        
                        // Action 2: Generate the chart in the side panel
                        generateSa2Chart(feature.properties.sa2_name);
                    }
                });
            }
        }).addTo(map);

        function updateLayerStyle() { geojsonLayer.eachLayer(layer => geojsonLayer.resetStyle(layer)); updateLegend(); }
        function updateLegend() { /* ... unchanged legend code ... */ }
        
        // ADDED: Event listener for the new close button
        document.getElementById('close-sa2-chart').addEventListener('click', function() {
            document.getElementById('sa2-chart-panel').classList.remove('visible');
            if (sa2ChartInstance) { sa2ChartInstance.destroy(); }
        });

        document.querySelectorAll('input[name="layerView"]').forEach(radio => {
            radio.addEventListener('change', (event) => { activeLayerView = event.target.value; updateLayerStyle(); });
        });

        // Initialize main trend chart (unchanged)
        const ctx = document.getElementById('trend-chart').getContext('2d');
        const features = json_canopy_area_cfin_2.features;
        const years = ['2011', '2015', '2019', '2021'];
        const totals = years.map(year => features.reduce((sum, f) => sum + (f.properties[`canopy_${year}_m2`] || 0), 0));
         // This is the restored code for the main chart
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [{
                    label: 'Total Canopy Coverage',
                    data: totals.map(t => (t / 1000000).toFixed(2)),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (context) => context.parsed.y + ' million m²' } }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Canopy Coverage (million m²)', font: { size: 11 } },
                        ticks: { font: { size: 10 } }
                    },
                    x: { ticks: { font: { size: 11, weight: 'bold' } } }
                }
            }
        });
        
        updateLegend();

        // The updateLegend function needs to be here in full
        function updateLegend() {
            const legendPanel = document.getElementById('legend-panel');
            const legendContent = document.getElementById('dynamic-legend-content');
            let newLegendHtml = '';
            
            if (activeLayerView === 'net_change') {
                legendPanel.querySelector('h3').innerText = '📊 Net Change Legend (2011-2021)';
                newLegendHtml = `<div class="legend-item"><div class="legend-color" style="background: #059669;"></div><span>Major Gain (>50k m²)</span></div><div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>Significant Gain (20k-50k m²)</span></div><div class="legend-item"><div class="legend-color" style="background: #6ee7b7;"></div><span>Minor Gain (0-20k m²)</span></div><div class="legend-item"><div class="legend-color" style="background: #94a3b8;"></div><span>No Change</span></div><div class="legend-item"><div class="legend-color" style="background: #fbbf24;"></div><span>Minor Loss (0 to -20k m²)</span></div><div class="legend-item"><div class="legend-color" style="background: #f97316;"></div><span>Significant Loss (-20k to -50k m²)</span></div><div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div><span>Major Loss (< -50k m²)</span></div>`;
            } else {
                const year = activeLayerView.split('_')[1];
                legendPanel.querySelector('h3').innerText = `🌳 Canopy Coverage ${year} Legend`;
                newLegendHtml = `<div class="legend-item"><div class="legend-color" style="background: #047857;"></div><span>> 200,000 m²</span></div><div class="legend-item"><div class="legend-color" style="background: #059669;"></div><span>> 100,000 m²</span></div><div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>> 50,000 m²</span></div><div class="legend-item"><div class="legend-color" style="background: #34d399;"></div><span>> 20,000 m²</span></div><div class="legend-item"><div class="legend-color" style="background: #6ee7b7;"></div><span>> 5,000 m²</span></div><div class="legend-item"><div class="legend-color" style="background: #a7f3d0;"></div><span>0 - 5,000 m²</span></div><div class="legend-item"><div class="legend-color" style="background: #e0e7e4;"></div><span>No/Missing Data</span></div>`;
            }
            legendContent.innerHTML = newLegendHtml;
        }

        console.log('✅ Tree Canopy Map Loaded Successfully!');
    </script>
</body>
</html>