<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <title>Tree Canopy Change Analysis (2011-2021)</title>
    
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        /* Smooth transitions for map features */
        .leaflet-interactive {
            transition: fill 0.3s ease, fill-opacity 0.3s ease;
        }
        
        #header {
            position: fixed; top: 0; left: 0; right: 0; height: 70px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000; display: flex; flex-direction: column; justify-content: center;
            align-items: center;
        }
        
        #header h1 { 
            font-size: 24px; 
            font-weight: 600; 
            margin-bottom: 5px;
        }
        #header .subtitle { font-size: 13px; opacity: 0.9; }
        
        #map { position: fixed; top: 70px; left: 0; right: 0; bottom: 0; }
        
        /* Panels with hover effects */
        #chart-panel, #legend-panel, #layer-selector-panel, #sa2-chart-panel {
            transition: all 0.3s ease;
        }
        
        #chart-panel:hover,
        #legend-panel:hover,
        #layer-selector-panel:hover,
        #sa2-chart-panel:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            transform: translateY(-2px);
        }
        
        #chart-panel {
            position: fixed; bottom: 20px; right: 20px; width: 420px;
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;
        }
        #chart-panel h3 { font-size: 16px; color: #1f2937; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #10b981; }
        
        #legend-panel {
            position: fixed; top: 90px; right: 20px; width: 280px;
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;
        }
        #legend-panel h3 { font-size: 14px; color: #1f2937; margin-bottom: 12px; font-weight: 600; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; }
        .legend-color { width: 30px; height: 16px; border-radius: 3px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2); flex-shrink: 0; }
        
        #layer-selector-panel {
            position: fixed; top: 90px; left: 20px; width: 240px;
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        #layer-selector-panel h3 { font-size: 14px; color: #1f2937; margin-bottom: 12px; font-weight: 600; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        
        /* Dropdown styling */
        #layer-dropdown {
            width: 100%; 
            padding: 10px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 13px; 
            background: white; 
            cursor: pointer; 
            color: #374151;
            transition: all 0.2s ease;
        }
        
        #layer-dropdown:hover {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        #layer-dropdown:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .leaflet-top.leaflet-left { left: 20px; top: 200px; }

        #sa2-chart-panel {
            position: fixed; bottom: 20px; left: 20px; width: 420px; height: 280px;
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1001;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #sa2-chart-panel.visible { 
            display: flex;
            opacity: 1;
        }
        #sa2-chart-panel h3 { font-size: 16px; color: #1f2937; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #10b981; }
        #sa2-chart-panel .chart-container { flex-grow: 1; position: relative; }
        
        #close-sa2-chart {
            position: absolute; 
            top: 10px; 
            right: 15px; 
            background: #fee2e2; 
            border: none;
            font-size: 20px; 
            font-weight: bold; 
            color: #dc2626; 
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        #close-sa2-chart:hover { 
            background: #dc2626;
            color: white;
            transform: rotate(90deg);
        }
        
        @media (max-width: 768px) {
            #chart-panel, #legend-panel, #layer-selector-panel { 
                width: calc(100% - 40px); 
                left: 20px; 
                right: 20px; 
            }
            #header h1 { font-size: 18px; }
            #chart-panel { bottom: 20px; }
            #legend-panel { top: 90px; }
            #layer-selector-panel { 
                top: auto; 
                bottom: calc(20px + 280px + 20px + 280px + 20px); 
            }
            #sa2-chart-panel { 
                width: calc(100% - 40px); 
                left: 20px; 
                bottom: calc(20px + 280px + 20px); 
            }
        }
    </style>
</head>
<body>
    
    <div id="header">
        <h1>üå≥ Tree Canopy Change Analysis (2011-2021)</h1>
        <div class="subtitle">Melbourne Region - Click on any area to see detailed statistics</div>
    </div>
    
    <div id="map"></div>

    <!-- Layer Selector with Dropdown -->
    <div id="layer-selector-panel">
        <h3>üó∫Ô∏è View Layer:</h3>
        <select id="layer-dropdown">
            <option value="net_change">üìä Net Change (2011-2021)</option>
            <option value="canopy_2011">üå± Canopy Coverage 2011</option>
            <option value="canopy_2015">üåø Canopy Coverage 2015</option>
            <option value="canopy_2019">üå≥ Canopy Coverage 2019</option>
            <option value="canopy_2021">üå≤ Canopy Coverage 2021</option>
        </select>
        
        <h3 style="margin-top: 20px;">üìç Filter by Region:</h3>
        <select id="region-filter-dropdown">
            <option value="all">üåè All Regions</option>
        </select>
        
        <div id="region-stats" style="margin-top: 12px; padding: 10px; background: #f0fdf4; border-radius: 6px; font-size: 12px; display: none;">
            <div style="font-weight: 600; color: #047857; margin-bottom: 5px;">Selected Region:</div>
            <div id="region-stats-content"></div>
        </div>
    </div>
    
    <!-- Legend Panel -->
    <div id="legend-panel">
        <h3>üìä Current Map Legend</h3>
        <div id="dynamic-legend-content"></div>
    </div>
    
    <!-- Main Trend Chart -->
    <div id="chart-panel">
        <h3>üìà Overall Canopy Trend</h3>
        <canvas id="trend-chart" width="380" height="200"></canvas>
        <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
            Total canopy coverage across all regions
        </div>
    </div>
    
    <!-- SA2 Region Chart Panel -->
    <div id="sa2-chart-panel">
        <button id="close-sa2-chart">√ó</button>
        <h3 id="sa2-chart-title">üìä Region Trend</h3>
        <div class="chart-container">
            <canvas id="sa2-chart-canvas"></canvas>
        </div>
    </div>

    <script src="js/leaflet.js"></script>
    <script src="data/canopy_area_cfin_2.js"></script>
    
    <script>
        // Initialize map
        var map = L.map('map', { 
            zoomControl: true, 
            maxZoom: 28, 
            minZoom: 10 
        }).fitBounds([[-37.8657, 144.8736], [-37.7572, 145.0403]]);
        
        // Add base layer
        L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            opacity: 0.3, 
            attribution: 'Map data ¬©2015 Google', 
            maxZoom: 20
        }).addTo(map);
        
        // Global variables
        let activeLayerView = 'net_change';
        let sa2ChartInstance = null;
        let selectedRegion = 'all';
        let allFeatures = json_canopy_area_cfin_2.features;

        // Color functions
        function getColorByChange(d) { 
            if (d === null || d === undefined) return '#94a3b8';
            return d > 50000 ? '#059669' : 
                   d > 20000 ? '#10b981' : 
                   d > 0 ? '#6ee7b7' : 
                   d === 0 ? '#94a3b8' : 
                   d > -20000 ? '#fbbf24' : 
                   d > -50000 ? '#f97316' : '#ef4444'; 
        }
        
        function getColorByCanopy(d) { 
            if (d === null || d === undefined) return '#e0e7e4';
            return d > 200000 ? '#047857' : 
                   d > 100000 ? '#059669' : 
                   d > 50000 ? '#10b981' : 
                   d > 20000 ? '#34d399' : 
                   d > 5000 ? '#6ee7b7' : 
                   d > 0 ? '#a7f3d0' : '#e0e7e4'; 
        }
        
        // Style function
        function styleFeature(feature) {
            let fillColor;
            if (activeLayerView === 'net_change') { 
                fillColor = getColorByChange(feature.properties.net_change_m2); 
            } else { 
                const year = activeLayerView.split('_')[1]; 
                fillColor = getColorByCanopy(feature.properties[`canopy_${year}_m2`]); 
            }
            return { 
                fillColor, 
                weight: 1, 
                opacity: 1, 
                color: '#ffffff', 
                fillOpacity: 0.75 
            };
        }
        
        // Create popup with detailed table
        function createPopup(properties) {
            const netChange = properties.net_change_m2 || 0;
            const changeSymbol = netChange > 0 ? '‚ñ≤' : netChange < 0 ? '‚ñº' : '‚óè';
            const changeColor = netChange > 0 ? '#059669' : netChange < 0 ? '#dc2626' : '#94a3b8';
            
            return `
                <div style="min-width: 300px; font-family: Arial; padding: 5px;">
                    <h3 style="margin: 0 0 10px 0; color: #047857; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-size: 18px;">
                        ${properties.sa2_name || 'Unknown Region'}
                    </h3>
                    <p style="margin: 8px 0; color: #666; font-size: 13px;">
                        <strong>SA1 Code:</strong> ${properties.sa1_code || 'N/A'}
                    </p>
                    
                    <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 18px; border-radius: 10px; margin: 15px 0; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 36px; font-weight: bold; color: ${changeColor};">
                            ${changeSymbol} ${Math.abs(netChange).toLocaleString()} m¬≤
                        </div>
                        <div style="font-size: 14px; color: #047857; font-weight: 600; margin-top: 8px;">
                            ${(properties.pct_change_total || 0).toFixed(1)}% Net Change (2011-2021)
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            Category: ${properties.change_category || 'N/A'}
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 8px; text-align: left; font-weight: 600;">Year</th>
                                <th style="padding: 8px; text-align: right; font-weight: 600;">Canopy (m¬≤)</th>
                                <th style="padding: 8px; text-align: right; font-weight: 600;">Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #f3f4f6;">
                                <td style="padding: 8px;"><strong>2011</strong></td>
                                <td style="padding: 8px; text-align: right;">${(properties.canopy_2011_m2 || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right; color: #94a3b8;">baseline</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f3f4f6; background: #fafafa;">
                                <td style="padding: 8px;"><strong>2015</strong></td>
                                <td style="padding: 8px; text-align: right;">${(properties.canopy_2015_m2 || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600; color: ${(properties.change_2011_2015_m2 || 0) >= 0 ? '#059669' : '#dc2626'};">
                                    ${(properties.change_2011_2015_m2 || 0) >= 0 ? '+' : ''}${(properties.change_2011_2015_m2 || 0).toLocaleString()}
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f3f4f6;">
                                <td style="padding: 8px;"><strong>2019</strong></td>
                                <td style="padding: 8px; text-align: right;">${(properties.canopy_2019_m2 || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600; color: ${(properties.change_2015_2019_m2 || 0) >= 0 ? '#059669' : '#dc2626'};">
                                    ${(properties.change_2015_2019_m2 || 0) >= 0 ? '+' : ''}${(properties.change_2015_2019_m2 || 0).toLocaleString()}
                                </td>
                            </tr>
                            <tr style="background: #fafafa;">
                                <td style="padding: 8px;"><strong>2021</strong></td>
                                <td style="padding: 8px; text-align: right;">${(properties.canopy_2021_m2 || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600; color: ${(properties.change_2019_2021_m2 || 0) >= 0 ? '#059669' : '#dc2626'};">
                                    ${(properties.change_2019_2021_m2 || 0) >= 0 ? '+' : ''}${(properties.change_2019_2021_m2 || 0).toLocaleString()}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>`;
        }

        // Generate SA2 regional chart
        function generateSa2Chart(sa2Name) {
            if (sa2ChartInstance) { 
                sa2ChartInstance.destroy(); 
            }

            const sa2Features = json_canopy_area_cfin_2.features.filter(f => f.properties.sa2_name === sa2Name);
            const years = ['2011', '2015', '2019', '2021'];
            const sa2Totals = years.map(year => 
                sa2Features.reduce((sum, f) => sum + (f.properties[`canopy_${year}_m2`] || 0), 0)
            );

            const panel = document.getElementById('sa2-chart-panel');
            const ctx = document.getElementById('sa2-chart-canvas').getContext('2d');
            document.getElementById('sa2-chart-title').innerText = `üìä Trend for ${sa2Name}`;
            
            sa2ChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: `Canopy Coverage (m¬≤) in ${sa2Name}`,
                        data: sa2Totals,
                        backgroundColor: ['rgba(110, 231, 183, 0.7)', 'rgba(52, 211, 153, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(5, 150, 105, 0.7)'],
                        borderColor: ['#6ee7b7', '#34d399', '#10b981', '#059669'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(2) + 'M m¬≤';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'k m¬≤';
                                    }
                                    return value.toLocaleString() + ' m¬≤';
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: false, 
                            ticks: { 
                                callback: v => (v >= 1e6 ? `${(v / 1e6).toFixed(1)}M` : v >= 1e3 ? `${(v / 1e3).toFixed(0)}k` : v) 
                            } 
                        } 
                    }
                }
            });
            
            panel.classList.add('visible');
        }
        
        // Highlight and reset functions
        function highlightFeature(e) {
            // Only highlight if region matches filter OR filter is "all"
            const featureRegion = e.target.feature.properties.sa2_name;
            
            if (selectedRegion === 'all' || featureRegion === selectedRegion) {
                e.target.setStyle({ 
                    weight: 3, 
                    color: '#fbbf24', 
                    fillOpacity: 0.9 
                }).bringToFront();
            }
        }
        
        function resetHighlight(e) {
            // Reset style based on whether it matches the filter
            const featureRegion = e.target.feature.properties.sa2_name;
            
            if (selectedRegion === 'all') {
                geojsonLayer.resetStyle(e.target);
            } else if (featureRegion === selectedRegion) {
                geojsonLayer.resetStyle(e.target);
            } else {
                // Keep faded style for non-matching regions
                e.target.setStyle({ opacity: 0.1, fillOpacity: 0.05 });
            }
        }
        
        // Add GeoJSON layer
        var geojsonLayer = L.geoJSON(json_canopy_area_cfin_2, {
            style: styleFeature,
            onEachFeature: function(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: function(e) {
                        // Open popup with table
                        L.popup({ maxWidth: 400, maxHeight: 500 })
                            .setLatLng(e.latlng)
                            .setContent(createPopup(feature.properties))
                            .openOn(map);
                        
                        // Generate chart in side panel
                        generateSa2Chart(feature.properties.sa2_name);
                    }
                });
            }
        }).addTo(map);

        // Update layer styles with loading indicator
        function updateLayerStyle() { 
            // Show loading cursor
            document.body.style.cursor = 'wait';
            
            // Update styles
            geojsonLayer.eachLayer(layer => geojsonLayer.resetStyle(layer)); 
            updateLegend();
            
            // Hide loading cursor
            setTimeout(() => {
                document.body.style.cursor = 'default';
            }, 300);
        }
        
        // Update legend based on active layer
        function updateLegend() {
            const legendPanel = document.getElementById('legend-panel');
            const legendContent = document.getElementById('dynamic-legend-content');
            let newLegendHtml = '';
            
            if (activeLayerView === 'net_change') {
                legendPanel.querySelector('h3').innerText = 'üìä Net Change Legend (2011-2021)';
                newLegendHtml = `
                    <div class="legend-item"><div class="legend-color" style="background: #059669;"></div><span>Major Gain (>50k m¬≤)</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>Significant Gain (20k-50k m¬≤)</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #6ee7b7;"></div><span>Minor Gain (0-20k m¬≤)</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #94a3b8;"></div><span>No Change / Missing</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #fbbf24;"></div><span>Minor Loss (0 to -20k m¬≤)</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #f97316;"></div><span>Significant Loss (-20k to -50k m¬≤)</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div><span>Major Loss (< -50k m¬≤)</span></div>
                `;
            } else {
                const year = activeLayerView.split('_')[1];
                legendPanel.querySelector('h3').innerText = `üå≥ Canopy Coverage ${year} Legend`;
                newLegendHtml = `
                    <div class="legend-item"><div class="legend-color" style="background: #047857;"></div><span>> 200,000 m¬≤</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #059669;"></div><span>100,000 - 200,000 m¬≤</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>50,000 - 100,000 m¬≤</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #34d399;"></div><span>20,000 - 50,000 m¬≤</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #6ee7b7;"></div><span>5,000 - 20,000 m¬≤</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #a7f3d0;"></div><span>0 - 5,000 m¬≤</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #e0e7e4;"></div><span>No/Missing Data</span></div>
                `;
            }
            legendContent.innerHTML = newLegendHtml;
        }
        
        // Dropdown event listener
        document.getElementById('layer-dropdown').addEventListener('change', function(e) {
            activeLayerView = e.target.value;
            updateLayerStyle();
        });
        
        // Close SA2 chart panel
        document.getElementById('close-sa2-chart').addEventListener('click', function() {
            document.getElementById('sa2-chart-panel').classList.remove('visible');
            if (sa2ChartInstance) { 
                sa2ChartInstance.destroy(); 
            }
        });

        // Initialize main trend chart
        const ctx = document.getElementById('trend-chart').getContext('2d');
        const features = json_canopy_area_cfin_2.features;
        const years = ['2011', '2015', '2019', '2021'];
        const totals = years.map(year => 
            features.reduce((sum, f) => sum + (f.properties[`canopy_${year}_m2`] || 0), 0)
        );
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [{
                    label: 'Total Canopy Coverage',
                    data: totals.map(t => (t / 1000000).toFixed(2)),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        callbacks: { 
                            label: (context) => context.parsed.y + ' million m¬≤' 
                        } 
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { 
                            display: true, 
                            text: 'Canopy Coverage (million m¬≤)', 
                            font: { size: 11 } 
                        },
                        ticks: { font: { size: 10 } }
                    },
                    x: { 
                        ticks: { 
                            font: { 
                                size: 11, 
                                weight: 'bold' 
                            } 
                        } 
                    }
                }
            }
        });
        
        // Initialize legend
        updateLegend();
        
        // Populate region filter dropdown
        function populateRegionFilter() {
            const regions = [...new Set(allFeatures.map(f => f.properties.sa2_name))].sort();
            const dropdown = document.getElementById('region-filter-dropdown');
            
            regions.forEach(region => {
                if (region) {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    dropdown.appendChild(option);
                }
            });
        }
        
        // Filter features by selected region
        function filterByRegion(regionName) {
            selectedRegion = regionName;
            
            geojsonLayer.eachLayer(function(layer) {
                if (regionName === 'all') {
                    layer.setStyle({ opacity: 1, fillOpacity: 0.75 });
                } else {
                    if (layer.feature.properties.sa2_name === regionName) {
                        layer.setStyle({ opacity: 1, fillOpacity: 0.75 });
                    } else {
                        layer.setStyle({ opacity: 0.1, fillOpacity: 0.05 });
                    }
                }
            });
            
            // Zoom to filtered region
            if (regionName !== 'all') {
                const filteredFeatures = allFeatures.filter(f => f.properties.sa2_name === regionName);
                if (filteredFeatures.length > 0) {
                    const bounds = L.geoJSON({
                        type: 'FeatureCollection',
                        features: filteredFeatures
                    }).getBounds();
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
                
                // Show region statistics
                updateRegionStats(regionName, filteredFeatures);
            } else {
                // Reset zoom to all regions
                map.fitBounds(geojsonLayer.getBounds());
                document.getElementById('region-stats').style.display = 'none';
            }
        }
        
        // Update region statistics panel
        function updateRegionStats(regionName, features) {
            const statsPanel = document.getElementById('region-stats');
            const statsContent = document.getElementById('region-stats-content');
            
            const total2021 = features.reduce((sum, f) => sum + (f.properties.canopy_2021_m2 || 0), 0);
            const total2011 = features.reduce((sum, f) => sum + (f.properties.canopy_2011_m2 || 0), 0);
            const netChange = total2021 - total2011;
            const pctChange = total2011 > 0 ? ((netChange / total2011) * 100).toFixed(1) : 0;
            const areasCount = features.length;
            
            const changeColor = netChange >= 0 ? '#059669' : '#dc2626';
            const changeSymbol = netChange >= 0 ? '‚ñ≤' : '‚ñº';
            
            statsContent.innerHTML = `
                <div style="color: #374151;"><strong>${regionName}</strong></div>
                <div style="margin-top: 8px; font-size: 11px;">
                    <div>Areas: <strong>${areasCount}</strong></div>
                    <div>Total 2021: <strong>${(total2021 / 1000).toFixed(1)}k m¬≤</strong></div>
                    <div style="color: ${changeColor}; font-weight: 600; margin-top: 4px;">
                        ${changeSymbol} ${Math.abs(netChange / 1000).toFixed(1)}k m¬≤ (${pctChange > 0 ? '+' : ''}${pctChange}%)
                    </div>
                </div>
            `;
            
            statsPanel.style.display = 'block';
        }
        
        // Region filter dropdown event listener
        document.getElementById('region-filter-dropdown').addEventListener('change', function(e) {
            filterByRegion(e.target.value);
        });
        
        // Populate region filter on load
        populateRegionFilter();

        console.log('‚úÖ Tree Canopy Map Loaded Successfully!');
        console.log('üìä Total Features:', features.length);
        console.log('üå≥ Click any region to see detailed statistics');
    </script>
</body>
</html>